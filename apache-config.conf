# Apache Virtual Host Configuration for llm.chrish.no
# This configuration sets up the search portal with logging

<VirtualHost *:80>
    ServerName llm.chrish.no
    DocumentRoot /var/www/ai-search-logger
    
    # Enable mod_rewrite
    RewriteEngine On
    
    # Log all requests to access log
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\" \"%{QUERY_STRING}e\"" search_combined
    CustomLog /var/log/apache2/llm.chrish.no_access.log search_combined
    ErrorLog /var/log/apache2/llm.chrish.no_error.log
    
    # Specific logging for search queries
    LogFormat "%t [SEARCH] IP:%h UA:\"%{User-agent}i\" Query:\"%{QUERY_STRING}e\" Referer:\"%{Referer}i\"" search_log
    
    # Log POST requests (search submissions) to a separate file
    SetEnvIf Request_Method "POST" is_search
    CustomLog /var/log/apache2/search_queries.log search_log env=is_search
    
    # Directory settings
    <Directory /var/www/ai-search-logger>
        AllowOverride All
        Require all granted
        
        # Enable PHP
        DirectoryIndex index.php index.html
        
        # Security headers
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
    </Directory>
    
    # PHP configuration
    php_admin_value upload_max_filesize 2M
    php_admin_value post_max_size 8M
    php_admin_value memory_limit 128M
    php_admin_value max_execution_time 30
    
    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>
    
    # Cache static files
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType image/png "access plus 1 month"
        ExpiresByType image/jpg "access plus 1 month"
        ExpiresByType image/jpeg "access plus 1 month"
        ExpiresByType image/gif "access plus 1 month"
        ExpiresByType image/ico "access plus 1 month"
        ExpiresByType image/icon "access plus 1 month"
        ExpiresByType text/ico "access plus 1 month"
        ExpiresByType application/ico "access plus 1 month"
    </IfModule>
</VirtualHost>

# HTTPS version (optional)
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName llm.chrish.no
    DocumentRoot /var/www/ai-search-logger
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/llm.chrish.no.crt
    SSLCertificateKeyFile /etc/ssl/private/llm.chrish.no.key
    # SSLCertificateChainFile /etc/ssl/certs/intermediate.crt
    
    # Same settings as HTTP version
    RewriteEngine On
    
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\" \"%{QUERY_STRING}e\"" search_combined_ssl
    CustomLog /var/log/apache2/llm.chrish.no_ssl_access.log search_combined_ssl
    ErrorLog /var/log/apache2/llm.chrish.no_ssl_error.log
    
    LogFormat "%t [SEARCH-SSL] IP:%h UA:\"%{User-agent}i\" Query:\"%{QUERY_STRING}e\" Referer:\"%{Referer}i\"" search_log_ssl
    SetEnvIf Request_Method "POST" is_search
    CustomLog /var/log/apache2/search_queries.log search_log_ssl env=is_search
    
    <Directory /var/www/ai-search-logger>
        AllowOverride All
        Require all granted
        DirectoryIndex index.php index.html
        
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    </Directory>
    
    php_admin_value upload_max_filesize 2M
    php_admin_value post_max_size 8M
    php_admin_value memory_limit 128M
    php_admin_value max_execution_time 30
    
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>
    
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType image/png "access plus 1 month"
        ExpiresByType image/jpg "access plus 1 month"
        ExpiresByType image/jpeg "access plus 1 month"
        ExpiresByType image/gif "access plus 1 month"
        ExpiresByType image/ico "access plus 1 month"
        ExpiresByType image/icon "access plus 1 month"
        ExpiresByType text/ico "access plus 1 month"
        ExpiresByType application/ico "access plus 1 month"
    </IfModule>
</VirtualHost>
</IfModule>